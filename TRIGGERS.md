# SQL Homework 9 - TRIGGERS

Created By: Miguel López
DATE: November 7, 2018 5:21 PM
Tested ON: Miscrosoft SQL Server 2017

---

## NOTAS

Los Triggers (Disparadores/Gatillos) son procedimientos almacenados especiales que se ejecutan solamente cuando se insertan, actualizando o eliminan registros de una tabla.

Dentro de un trigger se puede realizar:

1. Depurar variables.
2. Usar cursores
3. Modificar datos de toras tablas
4. Deshacer la transacción explícita con ROLLBACK TRAN

### CREACIÓN

```sql
CREATE TRIGGER NOMBRE_TRIGGER
ON NOMBRE_TABLA
[WITH ENCRYPTION]
FOR {[DELETE][,][INSERT][UPDATE]}
AS
SENTENCIAS_SQL
```

### MODIFICACIÓN

```sql
ALTER TRIGGER NOMBRE_TRIGGER
ON NOMBRE_TABLA
FOR{[DELETE][,][INSERT][,][UPDATE]}
```

### DROP

```sql
DROP TRIGGER NOMBRE_TRIGGER
```

### COOKBOOK

1. NO PERMITIR ACTUALIZACIONES MASIVAS

```sql
CREATE TRIGGER TR_PROD_UPD_MASIVE
ON Productos FOR UPDATE AS
DECLARE @CONTA INT
SELECT @CONTA = COUNT(*) FROM INSERTED

IF @CONTA > 1
BEGIN
	ROLLBACK TRAN
	RAISEERROR(SELECT 'NO SE PERMITEN ACTUALIZACIONES MASIVAS',16,1)
END
GO
-- NO ES PERMITIDO
UPDATE Productos SET PRECIO = 20
```

2. EVITA QUE BORREN LOS REGISTROS

```sql
CREATE TRIGGER TR_PROD_DEL_NOT
ON Products FOR DELETE AS
	ROLLBACK TRAN
	RAISEERROR(SELECT 'POR EL MOMENTO NO SE PUEDEN ELIMINAR REGISTROS',16,1)
GO
```

-- EJECUCIÓN
DELETE MATERIALES WHERE CLAVE = 5

## INSTRUCCIONES

USANDO LA BASE DE DATOS NORTHWIND DESARROLLA LOS TRIGGERS QUE REALIZEN LO SIGUIENTE.

[Script AQUI](scripts/Triggers.sql)

---

## TRIGGERS

1. Utilizando trigger, validar que solo se vendan ordenes de lunes a viernes.

```sql
CREATE TRIGGER TR_ORDERS_HABILES_INS
ON ORDERS FOR INSERT AS
	DECLARE @DW INT = 0
	SELECT @DW = DATEPART(DW,OrderDate) FROM INSERTED
	IF @DW IN (1,7)
	BEGIN
		ROLLBACK TRAN
		RAISEERROR(SELECT 'DIA DE LA SEMANA NO HÁBIL')
	END
```

EJECUCIÓN

```sql
INSERT INTO Orders VALUES('VINET',1,'2018-11-11','1996-08-01','1996-08-01',1,10,'Hanari Carnes', 'Luisenstr. 48', 'Lyon',null,51100,'France')
```

2. Validar que no se vendan mas de 20 ordenes por empleado en una semana

```sql
CREATE TRIGGER TR_ORDERS_LIMWEEK_INS
ON ORDERS FOR INSERT AS
	DECLARE @MORDER DATETIME, @ORDWEEK INT = 0
	SELECT @MORDER = MAX(OrderDate) FROM Orders

	SELECT @ORDWEEK = COUNT(*)
	FROM Orders
	WHERE DATEPART(MM,@MORDER) = DATEPART(MM,OrderDate) AND YEAR(@MORDER) = YEAR(OrderDate)

	IF @ORDWEEK > 20
	BEGIN
		ROLLBACK TRAN
		RAISEERROR(SELECT 'NÚMERO DE ORDENES POR SEMANA EXCEDIDO')
	END
```

EJECUCIÓN

```sql
INSERT INTO Orders VALUES('VINET',1,'1998-05-06','1996-08-01','1996-08-01',1,10,'Hanari Carnes', 'Luisenstr. 48', 'Lyon',null,51100,'France')
```

3. Validar que el campo firstname en la tabla employees solamente tenga nombres que inicien con vocal

```sql
CREATE TRIGGER TR_EMPLOYEES_VOCAL_INS
ON EMPLOYEES FOR INSERT AS
	DECLARE @FN VARCHAR = ''
	SELECT @FN = FirstName FROM INSERTED

	IF @FN NOT LIKE '[aeiou]%'
	BEGIN
		ROLLBACK TRAN
		RAISEERROR(SELECT 'NOMBRE DE EMPLEADO NO VÁLIDO, DEBE COMENZAR CON VOCAL')
	END
```

4. Validar que el importe de venta de cada orden no sea mayor a $10,000

```sql
CREATE TRIGGER TR_ORDERDETAILS_LIMIMPORT_INS
ON [ORDER DETAILS] FOR INSERT AS
	DECLARE @ORDERID INT
	SELECT @ORDERID = MAX(OrderID) FROM INSERTED
	WHILE @ORDERID IS NOT NULL
	BEGIN
		DECLARE @IMPORTE NUMERIC(12,2) = 0

		SELECT @IMPORTE = SUM(UnitPrice*Quantity)
		FROM INSERTED
		WHERE OrderID = @ORDERID

		IF @IMPORTE > 10000
		BEGIN
			ROLLBACK TRAN
			RAISEERROR(SELECT 'EL IMPORTE TOTAL DE ALGUNA DE LAS ORDENES INSERTADA EXCEDE EL MONTO DE 10,000$')
		END
	END
```

5. Validar que no se puedan eliminar ordenes que se hicieron los lunes

```sql
CREATE TRIGGER TR_ORDERS_MONDAY_DEL
ON ORDERS FOR DELETE AS
	DECLARE @DAY INT

	SELECT @DAY = DATEPART(DW, OrderDate) FROM DELETED
	IF @DAY IN (2)
	BEGIN
		ROLLBACK TRAN
		RAISEERROR(SELECT 'NO SE PUEDEN ELIMINAR LAS ORDENES DEL DÍA LUNES')
	END
```

6. Validar que no se realicen inserciones masivas en la tabla products

```sql
CREATE TRIGGER TR_PRODUCTS_INS_MAS
ON PRODUCTS FOR INSERT AS
	DECLARE @NPRODINSERTED INT

	SELECT @NPRODINSERTED = COUNT(*) FROM INSERTED
	IF @NPRODINSERTED > 1
	BEGIN
		ROLLBACK TRAN
		RAISEERROR(SELECT 'NO SE PUEDEN REALIZAR INSERCIONES MASIVAS EN LA TABLA PRODUCTS')
	END
```

7. Validar que no se pueda modificar el campo unitprice de la tabla [order details]

```sql
CREATE TRIGGER TR_ORDERDETAILS_UNITPRICE_UPD
ON [ORDER DETAILS] FOR UPDATE AS
	 if UPDATE(UnitPrice)
	 BEGIN
		ROLLBACK TRAN
		RAISEERROR(SELECT 'NO SE PUEDEN REALIZAR INSERCIONES MASIVAS EN LA TABLA PRODUCTS')
	 END
```

8. Validar que solo se pueda actualizar una sola vez el nombre del cliente

```sql
ALTER TABLE CUSTOMERS ADD CONTA INT
GO
UPDATE CUSTOMERS SET CONTA = 0
GO
CREATE TRIGGER TR_CUSTOMERS_LIMUPD_UPD
ON CUSTOMERS FOR UPDATE AS
	DECLARE @CLAVE VARCHAR(MAX) = '', @CONTA INT

	SELECT @CLAVE = CustomerID, @CONTA = CONTA FROM INSERTED

	IF UPDATE(CompanyName)
	BEGIN
		IF @CONTA > 0
		BEGIN
			ROLLBACK TRAN
			RAISEERROR(SELECT 'NO SE PUEDEN ACTUALIZAR EL NOMBRE DEL CLIENTE MÁS DE UNA VEZ')
		END
	END

```

9. Validar que no se puedan eliminar categorías que tengan una clave impar

```sql
CREATE TRIGGER TR_CATEGORIES_IDIMPAR_DEL
ON CATEGORIES FOR DELETE AS
	DECLARE @CLAVE INT
	SELECT @CLAVE = CategoryID FROM DELETED

	IF @CLAVE % 2 <> 0
	BEGIN
		ROLLBACK TRAN
		RAISEERROR(SELECT 'NO SE PUEDEN ELIMINAR REGISTROS CON CLAVE IMPAR DE LA TABLA CATEGORIAS')
	END
```

10. Validar que no se puedan insertar ordenes que se realicen en domingo

```sql
CREATE TRIGGER TR_ORDERS_WEEK_INS
ON ORDERS FOR INSERT AS
	DECLARE @DW INT = 0
	SELECT @DW = DATEPART(DW, OrderDate) FROM ORDERS
	IF @DW IN (1)
	BEGIN
		ROLLBACK TRAN
		RAISEERROR(SELECT 'NO SE PUEDEN REALIZAR INSERCIONES EN LA TABLA ORDERS LOS DÍAS DOMINGO')
	END
```

11. Validar que al insertar un empleado no genere que otro tenga más de 5 empleados a su cargo

```sql
CREATE TRIGGER TR_EMPLOYEES_INS_CARGOMAX_5
ON EMPLOYEES FOR INSERT AS

DECLARE @JEFE INT,@N INT

SELECT @JEFE = ReportsTo FROM INSERTED
SELECT @N = COUNT(*) FROM Employees WHERE ReportsTo = @JEFE

IF @N > 5
BEGIN
	RAISERROR('No se permite que un jefe tenga más de 5 empleados a su cargo',16,1)
	ROLLBACK TRAN
END
```

12. Validar que se realicen inserciones masivas en la tabla products, solo si son mas de 10 productos

```sql
CREATE TRIGGER TR_PRODUCTS_INS_MAS_10
ON PRODUCTS FOR INSERT
AS
	DECLARE @NPRODS INT

	SELECT @NPRODS = COUNT(*) FROM INSERTED
	IF @NPRODS < 10
	BEGIN
		RAISERROR('DEBE INSERTAR MÁS DE 10 PRODUCTOS',16,1)
		ROLLBACK TRAN
	END
GO
```
